#!/bin/sh

trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

_Modules() {
    while :; do
        echo "T:$(~/.config/leftwm/themes/Epitaph/scripts/lemonbar/time)"
        sleep 10s;
    done
}

_BatModule() {
    while :; do
        echo "B:$(~/.config/leftwm/themes/Epitaph/scripts/lemonbar/battery)"
        sleep 30s;
    done
}

_VolModule() {
    while :; do
        echo "V:$(~/.config/leftwm/themes/Epitaph/scripts/lemonbar/getvol)"
        sleep 0.5s;
    done
}

_Wininfo() {
    leftwm-state -s "{{workspaces[0].index | remove:'0'}}" | while read -r _; do
        get_tags=$(leftwm-state -w0 -q -s "{% for tag in workspace.tags %}{% if tag.mine %}%{R} {{tag.name}} %{R}{% elsif tag.visible %} {{tag.name}} {% elsif tag.busy %} {{tag.name}} {% else %} {{tag.name}}{% endif %}{% endfor %} | {{window_title | truncate: 30 }}")
        echo "K:$get_tags"
    done
}

lemon_fifo="/tmp/lemonfifo"

[ -e "$lemon_fifo" ] && rm "$lemon_fifo"
mkfifo "$lemon_fifo"

_VolModule > "$lemon_fifo" &
_BatModule > "$lemon_fifo" &
_Modules > "$lemon_fifo" &
_Wininfo > "$lemon_fifo" &

_Main() {
    while read -r report; do
        case $report in
            B*) batt="$(echo "${report##*:}")";;
            K*) wm="$(echo "${report##*:}")";;
            T*) time="$(echo "${report#*:}")";;
            V*) vol="$(echo "${report##*:}")";;
        esac
        sleep 0.2s
        printf "%s" "%{F#CDD6F4}%{R}$wm %{R} %{r}%{B#1e1e2e}%{F#89B4FA}%{R}%{F#1e1e2e}  $time %{B#89b4fa}%{F#a6e3a1}%{R}%{F#1e1e2e} $batt %{B#a6e3a1}%{F#f38ba8}%{R}%{F#1e1e2e} 墳 $vol %{B#f38ba8}%{F#c678dd}%{B#1e1e2e}"
    done
}

_Main < "$lemon_fifo"
