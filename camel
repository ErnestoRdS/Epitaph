#!/bin/sh

#stop processes on kill
trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

_Workspaces() {
        curr=$("$HOME"/.config/leftwm/themes/epitaph/scripts/lemonbar/wmdesk)
        printf "%s" "$("$HOME"/.config/leftwm/themes/epitaph/scripts/lemonbar/wmdesk -a)" | sed -e "s/$curr/%{R} $curr %{R}/"
}

_Modules() {
        while true; do
                echo "S:$(/usr/sbin/iwgetid -r || printf '%s' 'Disconnected')"
                echo "T:$("$HOME"/.config/leftwm/themes/epitaph/scripts/lemonbar/time &)"
                sleep 3
        done
}

_SysInfoModule() {
        while true; do
                echo "C:$("$HOME"/.config/leftwm/themes/epitaph/scripts/lemonbar/cpu_usage &)"
                echo "R:$("$HOME"/.config/leftwm/themes/epitaph/scripts/lemonbar/ram_usage &)"
                sleep 5;
        done
}

# Battery can be updated every five seconds, no battery drains that fast.
_BatModule() {
        while true; do
            echo "B:$("$HOME"/.config/leftwm/themes/epitaph/scripts/lemonbar/battery &)"
            sleep 5;
        done
}
# Volume module. This needs to be updated constantly to reflect the current vol.
_VolModule() {
        while true; do
        echo "V:$("$HOME"/.config/leftwm/themes/epitaph/scripts/lemonbar/getvol &)"
        sleep 0.2;
        done
}

_Wininfo() {
        leftwm-state | while read -r line; do
                echo "W:$("$HOME"/.config/leftwm/themes/epitaph/scripts/lemonbar/wmtitle | cut -c 1-30)"
                echo "K:$(_Workspaces &)"
        done
}

lemon_fifo="/tmp/lemonfifo"

[ -e "$lemon_fifo" ] && rm "$lemon_fifo"
mkfifo "$lemon_fifo"

_VolModule > "$lemon_fifo" &
_BatModule > "$lemon_fifo" &
_SysInfoModule > "$lemon_fifo" &
_Modules > "$lemon_fifo" &
_Wininfo > "$lemon_fifo" &

# TODO: Replace cut with: echo "${var1##*:}

_Main() {
        while read -r report; do
                case $report in
                        B*) batt="$(echo "$report" | cut -d':' -f2-)";;
                        C*) cpu="$(echo "$report" | cut -d':' -f2-)";;
                        K*) wm="$(echo "$report" | cut -d':' -f2-)";;
                        R*) ram="$(echo "$report" | cut -d':' -f2-)";;
                        S*) ssid="$(echo "$report" | cut -d':' -f2-)";;
                        T*) time="$(echo "$report" | cut -d':' -f2-)";;
                        V*) vol="$(echo "$report" | cut -d':' -f2-)";;
                        W*) wname="$(echo "$report" | cut -d':' -f2-)";;
                esac
                sleep 0.1s
                printf "%s" "%{F#FAFAFA}%{R} $wm %{R} $wname... %{r}%{B#282c34}%{F#E06c75}%{R}%{F#282c34} 龍 cpu: $cpu %{F#E5C07B}%{B#E06c75}%{R}%{F#282c34}  ram: $ram %{B#E5C07B}%{F#61AFEF}%{R}%{F#282c34}  $time %{B#61AFEF}%{F#98C379}%{R}%{F#282c34}  $batt %{B#98C379}%{F#DA8548}%{R}%{F#282c34} 墳 $vol %{B#DA8548}%{F#c678dd}%{R}%{F#282c34}  $ssid %{B#282c34}"
        done
}

_Main < "$lemon_fifo"
